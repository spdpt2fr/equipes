<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import CSV - Gestionnaire d'√âquipes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 30px; margin: 20px 0; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status { position: fixed; top: 10px; right: 10px; padding: 15px 25px; border-radius: 25px; color: white; font-weight: bold; z-index: 1000; }
        .connected { background: #4caf50; }
        .offline { background: #f44336; }
        .connecting { background: #ff9800; }
        h1 { text-align: center; color: #2196f3; margin-bottom: 30px; }
        textarea { width: 100%; height: 300px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 14px; }
        button { padding: 15px 30px; margin: 10px 5px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-primary:hover { background: #1976d2; transform: translateY(-2px); }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #388e3c; transform: translateY(-2px); }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; transform: translateY(-2px); }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; transform: translateY(-2px); }
        .progress { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 15px 0; }
        .progress-bar { height: 100%; background: #4caf50; transition: width 0.3s; border-radius: 10px; }
        .log { background: #f9f9f9; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; }
        .preview { background: #f0f8ff; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .preview-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        .preview-item:last-child { border-bottom: none; }
        .error { color: #f44336; background: #ffebee; padding: 8px; border-radius: 4px; margin: 5px 0; }
        .success { color: #388e3c; background: #e8f5e8; padding: 8px; border-radius: 4px; margin: 5px 0; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3; }
        .stat-number { font-size: 24px; font-weight: bold; color: #2196f3; }
        .stat-label { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div id="status" class="status connecting">üîÑ Connexion...</div>
    
    <h1>üìä Import CSV - Gestionnaire d'√âquipes</h1>
    
    <div class="card">
        <h2>üìÅ Format CSV Attendu</h2>
        <p><strong>Format :</strong> <code>Nom,Niveau,Poste</code></p>
        <p><strong>Exemple :</strong></p>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px;">Alex,9,avant
Claire,5,arriere
Jules,7,indifferent</pre>
        <p><strong>Postes accept√©s :</strong> avant, arriere, indifferent</p>
    </div>

    <div class="card">
        <h2>üìã Donn√©es CSV √† Importer</h2>
        <textarea id="csvData" placeholder="Collez vos donn√©es CSV ici...
Exemple:
Alex,9,avant
Claire,5,arriere
Jules,7,indifferent">Loran,6,arriere
Claire,5,avant
Fred,4,avant
Charles,7,avant
Alexis,7,indifferent
Arnaud,5,indifferent
LauLau,5,indifferent
Jules,7,indifferent
Nicolas,6,avant
Alex,9,avant
Soazig,3,avant
Alanis,4,avant
Gael,6,indifferent
Charlene,4,avant
11,9,avant
Favio,8,indifferent
Tif,6,indifferent
Romain,6,arriere
Thomas,5,avant
Doudou,5,avant
Quentin,6,avant
Blaise,5,arriere
Lison,6,avant
Nico S,5,indifferent
Charly,6,avant
Lamine,5,indifferent</textarea>
        
        <div style="margin: 20px 0;">
            <button onclick="previewData()" class="btn-primary">üëÄ Pr√©visualiser</button>
            <button onclick="importData()" class="btn-success">üì• Importer en Base</button>
            <button onclick="clearDatabase()" class="btn-danger">üóëÔ∏è Vider Base</button>
            <button onclick="goToApp()" class="btn-warning">üöÄ Aller √† l'App</button>
        </div>
    </div>

    <div id="previewSection" class="card" style="display: none;">
        <h2>üëÄ Pr√©visualisation</h2>
        <div class="stats" id="stats"></div>
        <div id="preview" class="preview"></div>
    </div>

    <div id="progressSection" class="card" style="display: none;">
        <h2>üìä Progression Import</h2>
        <div class="progress">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>
        <div id="progressText">Pr√©paration...</div>
    </div>

    <div class="card">
        <h2>üìù Journal d'Import</h2>
        <div id="log" class="log">En attente d'import...</div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://wwonmuezjfvtfjjnxczx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3b25tdWV6amZ2dGZqam54Y3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NDUxMTQsImV4cCI6MjA2NjUyMTExNH0.P4TY4lyr0aXavzz8tJlZJFb0v2sDFMZstIFH2vvipnw';
        
        let supabaseClient;
        let isOnline = false;
        let importedData = [];

        // Fonctions utilitaires
        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + className;
        }

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateProgress(current, total, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressSection = document.getElementById('progressSection');
            
            progressSection.style.display = 'block';
            
            const percentage = Math.round((current / total) * 100);
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${text} (${current}/${total} - ${percentage}%)`;
        }

        // Initialisation
        async function init() {
            try {
                updateStatus('üîÑ Connexion...', 'connecting');
                log('üîÑ Initialisation de la connexion Supabase...');
                
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test connexion
                const { data, error } = await supabaseClient.from('players').select('count(*)', { count: 'exact', head: true });
                if (error) throw error;
                
                isOnline = true;
                updateStatus('üü¢ Connect√©', 'connected');
                log('‚úÖ Connexion Supabase √©tablie avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur:', error);
                isOnline = false;
                updateStatus('üî¥ Hors ligne', 'offline');
                log('‚ùå Erreur connexion: ' + error.message, 'error');
            }
        }

        // Parsing et validation CSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const players = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                const lineNum = index + 1;
                const trimmedLine = line.trim();
                
                if (!trimmedLine) return; // Ignorer lignes vides
                
                const parts = trimmedLine.split(',').map(p => p.trim());
                
                if (parts.length !== 3) {
                    errors.push(`Ligne ${lineNum}: Format incorrect (${parts.length} colonnes au lieu de 3)`);
                    return;
                }
                
                const [nom, niveauStr, poste] = parts;
                
                // Validation nom
                if (!nom || nom.length < 1) {
                    errors.push(`Ligne ${lineNum}: Nom manquant ou invalide`);
                    return;
                }
                
                // Validation niveau
                const niveau = parseInt(niveauStr);
                if (isNaN(niveau) || niveau < 1 || niveau > 10) {
                    errors.push(`Ligne ${lineNum}: Niveau invalide (${niveauStr}) - doit √™tre entre 1 et 10`);
                    return;
                }
                
                // Validation poste
                const postesValides = ['avant', 'arriere', 'indifferent'];
                const posteNormalise = poste.toLowerCase()
                    .replace('√©', 'e')  // indiff√©rent -> indifferent
                    .replace('√®', 'e');
                
                if (!postesValides.includes(posteNormalise)) {
                    errors.push(`Ligne ${lineNum}: Poste invalide (${poste}) - doit √™tre: avant, arriere, ou indifferent`);
                    return;
                }
                
                players.push({
                    nom: nom,
                    niveau: niveau,
                    poste: posteNormalise,
                    groupe: null,
                    actif: true
                });
            });
            
            return { players, errors };
        }

        // Pr√©visualisation
        function previewData() {
            const csvText = document.getElementById('csvData').value;
            const { players, errors } = parseCSV(csvText);
            
            // Afficher section preview
            const previewSection = document.getElementById('previewSection');
            const preview = document.getElementById('preview');
            const stats = document.getElementById('stats');
            
            previewSection.style.display = 'block';
            
            // Statistiques
            const statsData = {
                total: players.length,
                avant: players.filter(p => p.poste === 'avant').length,
                arriere: players.filter(p => p.poste === 'arriere').length,
                indifferent: players.filter(p => p.poste === 'indifferent').length,
                niveauMoyen: players.length > 0 ? Math.round(players.reduce((sum, p) => sum + p.niveau, 0) / players.length * 10) / 10 : 0
            };
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${statsData.total}</div>
                    <div class="stat-label">Total joueurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${statsData.avant}</div>
                    <div class="stat-label">Avants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${statsData.arriere}</div>
                    <div class="stat-label">Arri√®res</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${statsData.indifferent}</div>
                    <div class="stat-label">Indiff√©rents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${statsData.niveauMoyen}</div>
                    <div class="stat-label">Niveau moyen</div>
                </div>
            `;
            
            // Preview des joueurs
            let previewHTML = '';
            
            if (errors.length > 0) {
                previewHTML += '<h3 style="color: #f44336;">‚ùå Erreurs d√©tect√©es:</h3>';
                errors.forEach(error => {
                    previewHTML += `<div class="error">${error}</div>`;
                });
            }
            
            if (players.length > 0) {
                previewHTML += '<h3 style="color: #4caf50;">‚úÖ Joueurs valides:</h3>';
                players.forEach((player, index) => {
                    previewHTML += `
                        <div class="preview-item">
                            <span><strong>${player.nom}</strong></span>
                            <span>Niveau ${player.niveau} - ${player.poste}</span>
                        </div>
                    `;
                });
            }
            
            preview.innerHTML = previewHTML;
            
            // Log
            log(`üìä Pr√©visualisation: ${players.length} joueurs valides, ${errors.length} erreurs`);
            
            // Stocker les donn√©es valid√©es
            importedData = players;
        }

        // Import en base
        async function importData() {
            if (!isOnline) {
                log('‚ùå Connexion Supabase requise pour l\'import', 'error');
                return;
            }
            
            if (importedData.length === 0) {
                log('‚ùå Aucune donn√©e √† importer. Pr√©visualisez d\'abord.', 'error');
                return;
            }
            
            if (!confirm(`Importer ${importedData.length} joueurs en base ?`)) {
                return;
            }
            
            try {
                log(`üöÄ D√©but import de ${importedData.length} joueurs...`);
                
                let imported = 0;
                let errors = 0;
                
                // Import par batch de 10 pour √©viter les timeouts
                const batchSize = 10;
                const batches = [];
                
                for (let i = 0; i < importedData.length; i += batchSize) {
                    batches.push(importedData.slice(i, i + batchSize));
                }
                
                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    
                    updateProgress(batchIndex, batches.length, 'Import en cours');
                    
                    try {
                        const { data, error } = await supabaseClient
                            .from('players')
                            .insert(batch)
                            .select();
                        
                        if (error) throw error;
                        
                        imported += batch.length;
                        log(`‚úÖ Batch ${batchIndex + 1}/${batches.length}: ${batch.length} joueurs import√©s`);
                        
                    } catch (batchError) {
                        errors += batch.length;
                        log(`‚ùå Erreur batch ${batchIndex + 1}: ${batchError.message}`, 'error');
                    }
                    
                    // Petit d√©lai entre les batches
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                updateProgress(batches.length, batches.length, 'Import termin√©');
                
                log(`üéâ Import termin√©: ${imported} r√©ussites, ${errors} erreurs`, 'success');
                
                if (imported > 0) {
                    updateStatus(`üü¢ ${imported} joueurs import√©s`, 'connected');
                }
                
            } catch (error) {
                log(`‚ùå Erreur import: ${error.message}`, 'error');
            }
        }

        // Vider la base
        async function clearDatabase() {
            if (!isOnline) {
                log('‚ùå Connexion Supabase requise', 'error');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ATTENTION: Vider toute la base de donn√©es ?')) {
                return;
            }
            
            try {
                log('üóëÔ∏è Suppression de tous les joueurs...');
                
                const { error } = await supabaseClient
                    .from('players')
                    .delete()
                    .neq('id', 0); // Supprimer tous
                
                if (error) throw error;
                
                log('‚úÖ Base de donn√©es vid√©e avec succ√®s', 'success');
                updateStatus('üü¢ Base vid√©e', 'connected');
                
            } catch (error) {
                log(`‚ùå Erreur suppression: ${error.message}`, 'error');
            }
        }

        // Aller √† l'application
        function goToApp() {
            window.open('https://equipesoksub.netlify.app/', '_blank');
        }

        // D√©marrage
        window.onload = init;
    </script>
</body>
</html>