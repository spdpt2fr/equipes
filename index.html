<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire d'Équipes - Hockey Subaquatique</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* === STYLES PRINCIPAUX === */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6fa; color: #212529; line-height: 1.5; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: box-shadow 0.3s ease; }
        .card:hover { box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15); }
        .card-title { font-size: 20px; font-weight: 500; color: #1976d2; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        /* === STATUS CONNEXION === */
        .status { position: fixed; top: 10px; right: 10px; padding: 12px 20px; border-radius: 25px; color: white; font-weight: bold; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .connected { background: #4caf50; }
        .offline { background: #f44336; }
        .connecting { background: #ff9800; }
        
        /* === FORMULAIRES === */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; align-items: end; margin-bottom: 16px; }
        .input-group { position: relative; display: flex; flex-direction: column; }
        .input-field { padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; transition: all 0.3s ease; outline: none; }
        .input-field:focus { border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); }
        .input-label { position: absolute; left: 16px; top: 12px; font-size: 14px; color: #666; pointer-events: none; transition: all 0.3s ease; background: white; padding: 0 4px; }
        .input-field:focus + .input-label, .input-field:not(:placeholder-shown) + .input-label { top: -8px; font-size: 12px; color: #1976d2; font-weight: 500; }
        
        /* === BOUTONS === */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; outline: none; }
        .btn:focus { box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3); }
        .btn-primary { background: #1976d2; color: white; }
        .btn-primary:hover { background: #1565c0; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3); }
        .btn-secondary { background: #388e3c; color: white; }
        .btn-secondary:hover { background: #2e7d32; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(56, 142, 60, 0.3); }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); }
        .btn-danger { background: #d32f2f; color: white; padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .btn-danger:hover { background: #c62828; transform: scale(1.1); }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .actions-grid { display: flex; gap: 12px; flex-wrap: wrap; }
        
        /* === LISTE DES JOUEURS === */
        .player-list { display: grid; gap: 12px; }
        .player-card { background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center; transition: all 0.3s ease; }
        .player-card:nth-child(even) { background: #f5f5f5; }
        .player-card:hover { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transform: translateY(-1px); }
        .player-card.inactive { opacity: 0.6; filter: grayscale(0.5); }
        .player-card.hidden { display: none; }
        .player-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; align-items: center; }
        .player-name { font-weight: 500; font-size: 16px; color: #1976d2; }
        .player-name-input { 
            font-weight: 700; 
            font-size: 16px; 
            color: #1976d2; 
            border: 1px solid transparent; 
            background: transparent; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: all 0.3s ease; 
            width: 100%; 
            min-width: 120px;
        }
        .player-name-input:hover { 
            border-color: #1976d2; 
            background: #f0f7ff; 
        }
        .player-name-input:focus { 
            outline: none; 
            border-color: #1976d2; 
            background: white; 
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2); 
        }
        .player-field { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .player-field label { font-size: 12px; color: #666; font-weight: 500; display: none; }
        .player-field input, .player-field select { padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; max-width: 100px; }
        
        /* Styles spécifiques pour identifier les champs */
        .player-field input[type="number"][placeholder*="Niveau"] { 
            border-left: 3px solid #1976d2; 
            background: #f0f7ff;
        }
        .player-field input[type="number"][placeholder*="Groupe"] { 
            border-left: 3px solid #f57c00;
            background: #fff8e1;
        }
        .player-field select { 
            border-left: 3px solid #388e3c;
            background: #f1f8e9;
        }
        
        /* Wrapper avec label pour le niveau */
        .niveau-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .niveau-label {
            font-size: 12px;
            color: #1976d2;
            font-weight: 600;
            min-width: 25px;
        }
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; accent-color: #1976d2; }
        
        /* === ÉQUIPES === */
        .teams-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-top: 16px; }
        .team-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .team-card:nth-child(1) { border-color: #1976d2; }
        .team-card:nth-child(2) { border-color: #388e3c; }
        .team-card:nth-child(3) { border-color: #f57c00; }
        .team-card:nth-child(4) { border-color: #d32f2f; }
        .team-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .team-title:nth-child(1) { color: #1976d2; }
        .team-players { list-style: none; margin-bottom: 16px; }
        .team-player { padding: 8px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .team-player:hover { background: #f5f5f5; padding-left: 8px; border-radius: 4px; }
        .team-total { font-weight: 700; color: #666; font-size: 14px; padding: 8px; background: #f9f9f9; border-radius: 6px; text-align: center; }
        .vs-stats { margin-top: 24px; padding: 16px; background: #f9f9f9; border-radius: 8px; }
        .vs-stats h3 { margin-bottom: 12px; color: #1976d2; }
        .vs-row { padding: 8px 0; border-bottom: 1px solid #e0e0e0; font-weight: 500; }
        
        /* === RECHERCHE === */
        .search-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; }
        .clear-search { background: #f57c00; color: white; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .clear-search:hover { background: #ef6c00; }
        .sort-toggle { background: #9c27b0; color: white; }
        .sort-toggle:hover { background: #7b1fa2; }
        .search-stats { font-size: 12px; color: #666; margin-left: auto; }
        
        /* === NOTIFICATIONS === */
        .toast { position: fixed; top: 20px; right: 20px; background: #388e3c; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.error { background: #d32f2f; }
        
        /* === SÉLECTEUR DE CLUBS === */
        .club-selector { 
            background: linear-gradient(135deg, #0077be 0%, #00a8cc 100%); 
            color: white; 
            padding: 16px 24px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            box-shadow: 0 4px 12px rgba(0, 119, 190, 0.3); 
            margin-bottom: 8px;
        }
        .club-selector select { 
            background: rgba(255, 255, 255, 0.9); 
            border: none; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-weight: 500; 
            font-size: 16px; 
            color: #333; 
            cursor: pointer;
            min-width: 200px;
        }
        .club-selector .club-info { 
            margin-left: auto; 
            font-size: 14px; 
            opacity: 0.9; 
        }
        .club-title { 
            font-size: 18px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        /* === MINI-DRAPEAUX CSS === */
        .flag {
            display: inline-block;
            width: 20px;
            height: 12px;
            margin-right: 6px;
            border: 1px solid #ccc;
            border-radius: 2px;
            position: relative;
            vertical-align: middle;
        }
        .flag-fr {
            background: linear-gradient(to right, #002654 0%, #002654 33%, #FFFFFF 33%, #FFFFFF 66%, #ED2939 66%);
        }
        .flag-gb {
            background: #012169;
            background-image: 
                linear-gradient(45deg, transparent 30%, white 30%, white 35%, transparent 35%),
                linear-gradient(-45deg, transparent 30%, white 30%, white 35%, transparent 35%),
                linear-gradient(45deg, transparent 65%, white 65%, white 70%, transparent 70%),
                linear-gradient(-45deg, transparent 65%, white 65%, white 70%, transparent 70%);
        }
        .flag-gb::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, transparent 45%, #C8102E 45%, #C8102E 55%, transparent 55%),
                linear-gradient(to bottom, transparent 45%, #C8102E 45%, #C8102E 55%, transparent 55%);
        }
        
        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .player-info { grid-template-columns: 1fr; }
            .teams-grid { grid-template-columns: 1fr; }
            .actions-grid { flex-direction: column; }
            .search-controls { flex-direction: column; align-items: stretch; }
            .search-stats { margin-left: 0; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="status" class="status connecting">🔄 Connexion...</div>
    
    <div class="container">
        <!-- Titre principal -->
        <div class="card">
            <h1 style="text-align: center; color: #0077be; margin: 0; font-size: 28px;">
                🤿 Gestionnaire d'Équipes - Hockey Subaquatique 🏒
            </h1>
        </div>

        <!-- Sélecteur de Club -->
        <div class="club-selector">
            <div class="club-title">
                🏊‍♂️ Club actuel :
            </div>
            <select id="clubSelect">
                <option value="grenoble">🏔️ Grenoble (France)</option>
                <option value="jeeves">🌊 Jeeves (UK)</option>
            </select>
            <div class="club-info" id="clubInfo">
                Chargement...
            </div>
        </div>

        <!-- Saisie des joueurs -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">person_add</span>
                Saisie des Joueurs
            </h2>
            <div class="form-grid">
                <div class="input-group">
                    <input id="nom" type="text" class="input-field" placeholder=" " required>
                    <label class="input-label">Nom du joueur</label>
                </div>
                <div class="input-group">
                    <input id="niveau" type="number" class="input-field" placeholder=" " min="1" max="10" required>
                    <label class="input-label">Niveau (1-10)</label>
                </div>
                <div class="input-group">
                    <select id="poste" class="input-field">
                        <option value="arriere">Arrière</option>
                        <option value="pivot">Pivot</option>
                        <option value="centre">Centre</option>
                        <option value="ailier">Ailier</option>
                        <option value="indifferent">Indifférent</option>
                    </select>
                </div>
                <div class="input-group">
                    <input id="groupe" type="number" class="input-field" placeholder=" " min="1">
                    <label class="input-label">Groupe (optionnel)</label>
                </div>
                <button id="ajouterBtn" class="btn btn-primary">
                    <span class="material-icons">add</span>
                    Ajouter Joueur
                </button>
            </div>
        </div>
        <!-- Import / Export et Actions -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">import_export</span>
                Import / Export et Actions
            </h2>
            <div class="actions-grid">
                <div class="file-input-wrapper">
                    <input accept=".txt,.csv" id="fichierJoueurs" type="file" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('fichierJoueurs').click();">
                        <span class="material-icons">upload_file</span>
                        Importer fichier
                    </button>
                </div>
                <button id="exportBtn" class="btn btn-secondary">
                    <span class="material-icons">download</span>
                    Exporter CSV
                </button>
                <button id="syncBtn" class="btn btn-warning">
                    <span class="material-icons">sync</span>
                    Synchroniser
                </button>
            </div>
        </div>

        <!-- Composition des équipes -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">groups</span>
                Composition des Équipes
            </h2>
            <div class="form-grid">
                <div class="input-group">
                    <input id="nombreEquipes" type="number" class="input-field" placeholder=" " min="1" required>
                    <label class="input-label">Nombre d'équipes</label>
                </div>
                <button id="creerBtn" class="btn btn-primary">
                    <span class="material-icons">group_add</span>
                    Créer Équipes
                </button>
            </div>
        </div>

        <!-- Liste des joueurs avec recherche -->
        <div class="card" id="listeJoueursCard" style="display: none;">
            <h2 class="card-title">
                <span class="material-icons">list</span>
                Liste des Joueurs
            </h2>
            
            <!-- Contrôles de recherche et tri -->
            <div class="search-controls">
                <div class="input-group search-input">
                    <input id="searchInput" type="text" class="input-field" placeholder=" ">
                    <label class="input-label">Rechercher un joueur...</label>
                </div>
                <button id="clearSearch" class="clear-search">
                    <span class="material-icons">clear</span>
                    Effacer
                </button>
                <button id="sortToggle" class="btn sort-toggle">
                    <span class="material-icons">sort_by_alpha</span>
                    <span id="sortText">Alphabétique</span>
                </button>
                <div class="search-stats" id="searchStats"></div>
            </div>
            
            <div id="listeJoueurs" class="player-list"></div>
        </div>

        <!-- Équipes -->
        <div id="equipesContainer"></div>
    </div>

    <script>
        // === CONFIGURATION SUPABASE ===
        const SUPABASE_URL = 'https://wwonmuezjfvtfjjnxczx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3b25tdWV6amZ2dGZqam54Y3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NDUxMTQsImV4cCI6MjA2NjUyMTExNH0.P4TY4lyr0aXavzz8tJlZJFb0v2sDFMZstIFH2vvipnw';
        
        // === VARIABLES GLOBALES ===
        let supabaseClient;
        let joueurs = [];
        let equipes = [];
        let clubs = [];
        let clubActuel = null;
        let isOnline = false;
        let afficherTotal = true;
        let triJoueurs = 'alpha'; // Par défaut alphabétique
        let triEquipes = 'alpha'; // Tri pour les équipes
        let searchTerm = '';

        // === GESTION DES CLUBS ===
        function getClubSauvegarde() {
            return localStorage.getItem('hockeySub_clubActuel') || 'grenoble';
        }

        function sauvegarderClub(clubId) {
            localStorage.setItem('hockeySub_clubActuel', clubId);
        }

        async function chargerClubs() {
            try {
                const { data, error } = await supabaseClient.from('clubs').select('*');
                if (error) throw error;
                clubs = data || [];
                
                // Initialiser le club actuel
                const clubSauvegarde = getClubSauvegarde();
                clubActuel = clubs.find(c => c.nom.toLowerCase() === clubSauvegarde) || clubs[0];
                
                // Mettre à jour le sélecteur
                document.getElementById('clubSelect').value = clubActuel.nom.toLowerCase();
                
                return clubs;
            } catch (error) {
                console.error('Erreur chargement clubs:', error);
                // Mode fallback
                clubs = [
                    { id: 1, nom: 'Grenoble' },
                    { id: 2, nom: 'Jeeves' }
                ];
                clubActuel = clubs[0];
                return clubs;
            }
        }

        function changerClub() {
            const selectClub = document.getElementById('clubSelect');
            const nomClub = selectClub.value;
            clubActuel = clubs.find(c => c.nom.toLowerCase() === nomClub);
            
            sauvegarderClub(nomClub);
            
            // Recharger les joueurs pour le nouveau club
            chargerJoueurs();
            
            showToast(`Basculé vers le club ${clubActuel.nom}`);
        }

        async function chargerJoueurs() {
            try {
                if (!clubActuel) return;
                
                const { data, error } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('club_id', clubActuel.id);
                
                if (error) throw error;
                
                joueurs = (data || []).map(j => ({
                    id: j.id,
                    nom: j.nom,
                    niveau: j.niveau,
                    poste: j.poste,
                    groupe: j.groupe,
                    actif: j.actif !== false
                }));
                
                // Mettre à jour l'info du club
                document.getElementById('clubInfo').textContent = `${joueurs.length} joueur(s)`;
                
                return joueurs;
            } catch (error) {
                console.error('Erreur chargement joueurs:', error);
                joueurs = [];
                return [];
            }
        }

        // === FONCTIONS UTILITAIRES ===
        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + className;
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // === INITIALISATION ===
        async function init() {
            try {
                updateStatus('🔄 Connexion...', 'connecting');
                console.log('Initialisation...');
                
                // Créer client Supabase
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Client Supabase créé');
                
                // Charger les clubs en premier
                await chargerClubs();
                console.log('Clubs chargés:', clubs);
                
                // Charger les joueurs pour le club actuel
                await chargerJoueurs();
                
                isOnline = true;
                updateStatus(`🟢 Connecté (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');
                console.log('Connexion OK, joueurs chargés:', joueurs.length);
                afficherJoueurs();
                showToast(`Connexion réussie ! Club: ${clubActuel.nom}`);
                
            } catch (error) {
                console.error('Erreur connexion:', error);
                isOnline = false;
                updateStatus('🔴 Hors ligne', 'offline');
                showToast('Mode hors ligne - ' + (error.message || 'Connexion impossible'), true);
            }
        }

        // === GESTION DES JOUEURS ===
        async function ajouterJoueur() {
            const nom = document.getElementById('nom').value.trim();
            const niveau = parseInt(document.getElementById('niveau').value);
            const poste = document.getElementById('poste').value;
            const groupe = parseInt(document.getElementById('groupe').value) || null;

            if (!nom) {
                showToast('Veuillez saisir un nom de joueur', true);
                return;
            }

            if (!niveau || niveau < 1 || niveau > 10) {
                showToast('Le niveau doit être entre 1 et 10', true);
                return;
            }

            // Vérifier si le joueur existe déjà
            if (joueurs.find(j => j.nom.toLowerCase() === nom.toLowerCase())) {
                showToast('Ce joueur existe déjà', true);
                return;
            }

            const nouveauJoueur = { nom, niveau, poste, groupe, actif: true, club_id: clubActuel.id };

            try {
                if (isOnline) {
                    const { data, error } = await supabaseClient
                        .from('players')
                        .insert([nouveauJoueur])
                        .select();
                    
                    if (error) throw error;
                    
                    nouveauJoueur.id = data[0].id;
                    showToast(`Joueur ${nom} ajouté et synchronisé !`);
                } else {
                    nouveauJoueur.id = Date.now(); // ID temporaire en mode hors ligne
                    showToast(`Joueur ${nom} ajouté (mode hors ligne)`);
                }

                joueurs.push(nouveauJoueur);
                afficherJoueurs();
                updateStatus(`🟢 Connecté (${joueurs.length} joueurs)`, 'connected');

                // Reset form
                document.getElementById('nom').value = '';
                document.getElementById('niveau').value = '';
                document.getElementById('groupe').value = '';
                document.getElementById('nom').focus();

            } catch (error) {
                console.error('Erreur ajout joueur:', error);
                showToast('Erreur: ' + error.message, true);
            }
        }

        async function supprimerJoueur(index) {
            if (!confirm("Supprimer ce joueur ?")) return;
            
            const joueur = joueurs[index];
            const nom = joueur.nom;

            try {
                if (isOnline && joueur.id) {
                    const { error } = await supabaseClient
                        .from('players')
                        .delete()
                        .eq('id', joueur.id);
                    
                    if (error) throw error;
                    showToast(`Joueur ${nom} supprimé de la base !`);
                } else {
                    showToast(`Joueur ${nom} supprimé (mode hors ligne)`);
                }
                
                joueurs.splice(index, 1);
                afficherJoueurs();
                updateStatus(`🟢 Connecté (${joueurs.length} joueurs)`, 'connected');
                
            } catch (error) {
                console.error('Erreur suppression:', error);
                showToast('Erreur: ' + error.message, true);
            }
        }

        async function modifierJoueur(index, champ, valeur) {
            const joueur = joueurs[index];
            const ancienneValeur = joueur[champ];

            if (champ === 'nom') {
                const nouveauNom = valeur.trim();
                if (!nouveauNom) {
                    showToast('Le nom ne peut pas être vide', true);
                    afficherJoueurs(); // Restaurer l'ancien nom
                    return;
                }
                // Vérifier si le nom existe déjà
                const nomExiste = joueurs.some((j, i) => i !== index && j.nom.toLowerCase() === nouveauNom.toLowerCase());
                if (nomExiste) {
                    showToast('Ce nom existe déjà', true);
                    afficherJoueurs(); // Restaurer l'ancien nom
                    return;
                }
                joueur[champ] = nouveauNom;
                showToast(`Nom modifié : ${ancienneValeur} → ${nouveauNom}`);
            } else if (champ === 'niveau') {
                const niveau = parseInt(valeur);
                if (niveau < 1 || niveau > 10) {
                    showToast('Le niveau doit être entre 1 et 10', true);
                    afficherJoueurs();
                    return;
                }
                joueur[champ] = niveau;
            } else if (champ === 'actif') {
                joueur[champ] = valeur;
            } else if (champ === 'groupe') {
                joueur[champ] = valeur ? parseInt(valeur) : null;
            } else {
                joueur[champ] = valeur;
            }

            // Synchroniser avec Supabase si en ligne
            try {
                if (isOnline && joueur.id) {
                    const updateData = {
                        nom: joueur.nom,
                        niveau: joueur.niveau,
                        poste: joueur.poste,
                        groupe: joueur.groupe,
                        actif: joueur.actif
                    };

                    const { error } = await supabaseClient
                        .from('players')
                        .update(updateData)
                        .eq('id', joueur.id);
                    
                    if (error) throw error;
                }
            } catch (error) {
                console.error('Erreur synchronisation modification:', error);
                showToast('Modification locale OK, sync échouée', true);
            }

            afficherJoueurs();
            
            // Si des équipes existent, les mettre à jour aussi
            if (equipes.length > 0) {
                equipes.forEach(equipe => {
                    const joueurDansEquipe = equipe.joueurs.find(j => j.id === joueur.id || j.nom === ancienneValeur);
                    if (joueurDansEquipe && champ === 'nom') {
                        joueurDansEquipe.nom = valeur.trim();
                    }
                });
                afficherEquipes();
            }
        }

        // === FONCTIONS DE RECHERCHE ET TRI ===
        function rechercherJoueurs() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            afficherJoueurs();
        }

        function effacerRecherche() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            afficherJoueurs();
        }

        function filtrerJoueurs(joueursListe) {
            if (!searchTerm) return joueursListe;
            return joueursListe.filter(joueur => 
                joueur.nom.toLowerCase().includes(searchTerm) ||
                joueur.poste.toLowerCase().includes(searchTerm) ||
                joueur.niveau.toString().includes(searchTerm)
            );
        }

        function trierJoueurs(joueursListe) {
            const joueursCopie = [...joueursListe];
            if (triJoueurs === 'alpha') {
                return joueursCopie.sort((a, b) => a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
            } else {
                return joueursCopie.sort((a, b) => b.niveau - a.niveau || a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
            }
        }

        function toggleTriJoueurs() {
            triJoueurs = triJoueurs === 'niveau' ? 'alpha' : 'niveau';
            document.getElementById('sortText').textContent = triJoueurs === 'alpha' ? 'Alphabétique' : 'Par niveau';
            afficherJoueurs();
        }

        function toggleTriEquipes() {
            triEquipes = triEquipes === 'niveau' ? 'alpha' : 'niveau';
            afficherEquipes();
        }

        function toggleTotalNiveaux() {
            afficherTotal = !afficherTotal;
            afficherEquipes();
        }

        // === AFFICHAGE DES JOUEURS ===
        function afficherJoueurs() {
            const carte = document.getElementById('listeJoueursCard');
            const liste = document.getElementById('listeJoueurs');
            const statsElement = document.getElementById('searchStats');

            if (joueurs.length === 0) {
                carte.style.display = 'none';
                return;
            }

            carte.style.display = 'block';
            liste.innerHTML = '';

            // Trier puis filtrer les joueurs
            const joueursTries = trierJoueurs(joueurs);
            const joueursFiltres = filtrerJoueurs(joueursTries);

            // Mettre à jour les statistiques
            const totalJoueurs = joueurs.length;
            const joueursActifs = joueurs.filter(j => j.actif).length;
            const joueursAffiches = joueursFiltres.length;
            
            let statsText = `${totalJoueurs} joueur(s) total`;
            if (joueursActifs !== totalJoueurs) {
                statsText += ` (${joueursActifs} actifs)`;
            }
            if (searchTerm) {
                statsText += ` - ${joueursAffiches} trouvé(s)`;
            }
            statsElement.textContent = statsText;

            joueursFiltres.forEach((j, index) => {
                const originalIndex = joueurs.indexOf(j);
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${!j.actif ? 'inactive' : ''}`;

                playerCard.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" ${j.actif ? 'checked' : ''} onchange="modifierJoueur(${originalIndex}, 'actif', this.checked)">
                    </div>
                    <div class="player-info">
                        <div class="player-field">
                            <input type="text" value="${j.nom}" class="player-name-input" 
                                   onchange="modifierJoueur(${originalIndex}, 'nom', this.value)"
                                   onblur="modifierJoueur(${originalIndex}, 'nom', this.value)"
                                   placeholder="Nom du joueur">
                        </div>
                        <div class="player-field">
                            <div class="niveau-wrapper">
                                <span class="niveau-label">Niv.</span>
                                <input type="number" value="${j.niveau}" min="1" max="10" 
                                       onchange="modifierJoueur(${originalIndex}, 'niveau', this.value)"
                                       placeholder="1-10" title="Niveau de 1 à 10">
                            </div>
                        </div>
                        <div class="player-field">
                            <select onchange="modifierJoueur(${originalIndex}, 'poste', this.value)" title="Position du joueur">
                                <option value="arriere" ${j.poste==='arriere'?'selected':''}>Arrière</option>
                                <option value="pivot" ${j.poste==='pivot'?'selected':''}>Pivot</option>
                                <option value="centre" ${j.poste==='centre'?'selected':''}>Centre</option>
                                <option value="ailier" ${j.poste==='ailier'?'selected':''}>Ailier</option>
                                <option value="indifferent" ${j.poste==='indifferent'?'selected':''}>Indifférent</option>
                            </select>
                        </div>
                        <div class="player-field">
                            <input type="number" value="${j.groupe || ''}" min="1" 
                                   onchange="modifierJoueur(${originalIndex}, 'groupe', this.value)"
                                   placeholder="Groupe" title="Numéro de groupe (optionnel)">
                        </div>
                    </div>
                    <button onclick="supprimerJoueur(${originalIndex})" class="btn btn-danger">
                        <span class="material-icons">delete</span>
                    </button>
                `;

                liste.appendChild(playerCard);
            });
        }

        // === CRÉATION ET AFFICHAGE DES ÉQUIPES ===
        function creerEquipes() {
            const nbEquipes = parseInt(document.getElementById('nombreEquipes').value);
            if (isNaN(nbEquipes) || nbEquipes <= 0) {
                showToast('Nombre d\'équipes invalide', true);
                return;
            }

            const joueursActifs = joueurs.filter(j => j.actif);
            if (joueursActifs.length === 0) {
                showToast('Aucun joueur actif disponible', true);
                return;
            }

            equipes = Array.from({length: nbEquipes}, () => ({
                joueurs: [],
                niveauTotal: 0,
                meilleurNiveau: 0,
                avant: 0,
                arriere: 0
            }));

            const groupes = {};
            const sansGroupe = [];

            joueursActifs.forEach(j => {
                if (j.groupe) {
                    if (!groupes[j.groupe]) groupes[j.groupe] = [];
                    groupes[j.groupe].push(j);
                } else {
                    sansGroupe.push(j);
                }
            });

            // Assigner les groupes ensemble
            Object.values(groupes).forEach(groupe => {
                groupe.sort((a,b) => b.niveau - a.niveau);
                equipes.sort((a,b) => a.niveauTotal - b.niveauTotal);
                groupe.forEach(j => {
                    let poste = j.poste;
                    if (poste === 'indifferent') poste = equipes[0].avant <= equipes[0].arriere ? 'avant' : 'arriere';
                    equipes[0].joueurs.push({...j, poste});
                    equipes[0].niveauTotal += j.niveau;
                    equipes[0].meilleurNiveau = Math.max(equipes[0].meilleurNiveau, j.niveau);
                    equipes[0][poste]++;
                });
            });

            // Ajouter les joueurs seuls
            sansGroupe.sort((a,b) => b.niveau - a.niveau);
            sansGroupe.forEach(joueur => {
                equipes.sort((a,b) => a.niveauTotal - b.niveauTotal);
                let poste = joueur.poste;
                if (poste === 'indifferent') poste = equipes[0].avant <= equipes[0].arriere ? 'avant' : 'arriere';
                equipes[0].joueurs.push({...joueur, poste});
                equipes[0].niveauTotal += joueur.niveau;
                equipes[0].meilleurNiveau = Math.max(equipes[0].meilleurNiveau, joueur.niveau);
                equipes[0][poste]++;
            });

            afficherEquipes();
            showToast('Équipes créées avec succès');
        }

        function afficherEquipes() {
            const container = document.getElementById('equipesContainer');
            if (equipes.length === 0) {
                container.innerHTML = '';
                return;
            }

            // Calcul des scores "compétitifs" (6 meilleurs joueurs max) + 2ème meilleur joueur
            function scoreEquipe(equipe) {
                let joueursOrdonnes = [...equipe.joueurs].sort((a, b) => b.niveau - a.niveau);
                if (joueursOrdonnes.length > 6) {
                    const joueursPrisEnCompte = joueursOrdonnes.slice(0, 6);
                    const joueursIgnorés = joueursOrdonnes.slice(6);
                    const meilleur = joueursPrisEnCompte[0]?.niveau || 0;
                    const second = joueursPrisEnCompte[1]?.niveau || 0;
                    const total = joueursPrisEnCompte.reduce((acc, j) => acc + j.niveau, 0);
                    return {
                        score: total * 0.6 + meilleur * 0.25 + second * 0.15,
                        meilleur,
                        second,
                        joueursIgnorés
                    };
                } else {
                    const meilleur = joueursOrdonnes[0]?.niveau || 0;
                    const second = joueursOrdonnes[1]?.niveau || 0;
                    const total = equipe.niveauTotal;
                    return {
                        score: total * 0.6 + meilleur * 0.25 + second * 0.15,
                        meilleur,
                        second,
                        joueursIgnorés: []
                    };
                }
            }
            
            // Calcul des scores compétitifs pour chaque équipe
            const scoresObj = equipes.map(e => scoreEquipe(e));
            const scores = scoresObj.map(e => e.score);

            let html = `
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-icons">groups</span>
                        Équipes Constituées
                        <button onclick="toggleTotalNiveaux()" class="btn btn-secondary" style="margin-left: auto;">
                            ${afficherTotal ? 'Cacher' : 'Afficher'} totaux
                        </button>
                        <button onclick="toggleTriEquipes()" class="btn btn-secondary" style="margin-left: 8px;">
                            Trier : ${triEquipes === 'niveau' ? 'par niveau' : 'alphabétique'}
                        </button>
                    </h2>
                    <div class="teams-grid">
            `;

            equipes.forEach((e, idx) => {
                const teamColors = ['#1976d2', '#388e3c', '#f57c00', '#d32f2f'];
                const color = teamColors[idx % teamColors.length];

                html += `
                    <div class="team-card">
                        <div class="team-title" style="color: ${color}">
                            <span class="material-icons">group</span>
                            Équipe ${idx + 1}
                        </div>
                        <ul class="team-players">
                `;

                // Tri dynamique des joueurs dans les équipes
                let joueursAffiches = [...e.joueurs];
                if (triEquipes === 'niveau') {
                    joueursAffiches.sort((a, b) => b.niveau - a.niveau);
                } else if (triEquipes === 'alpha') {
                    joueursAffiches.sort((a, b) => a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
                }

                joueursAffiches.forEach((j, joueurIdx) => {
                    html += `
                        <li class="team-player" onclick="changerEquipe(${idx}, ${e.joueurs.indexOf(j)})">
                            <span class="material-icons">person</span>
                            ${j.nom} - ${j.poste}${afficherTotal ? ' (' + j.niveau + ')' : ''}
                        </li>
                    `;
                });

                html += '</ul>';
                if (afficherTotal) {
                    html += `<div class="team-total">Score compétitif : ${scoresObj[idx].score.toFixed(2)}<br>
                        <span style="font-size:12px;">
                        (Somme × 0.6 : ${(e.joueurs.length > 6 
                            ? [...e.joueurs].sort((a,b) => b.niveau-a.niveau).slice(0,6).reduce((acc, j) => acc+j.niveau,0)
                            : e.niveauTotal
                        ).toFixed(2)}
                        , meilleur × 0.25 : ${(scoresObj[idx].meilleur*0.25).toFixed(2)}
                        , 2e meilleur × 0.15 : ${(scoresObj[idx].second*0.15).toFixed(2)})
                        </span>`;
                    if (scoresObj[idx].joueursIgnorés.length > 0) {
                        html += `<br><span style="color:#d32f2f; font-size:12px;">(Le(s) joueur(s) non pris en compte : ${scoresObj[idx].joueursIgnorés.map(j => j.nom).join(', ')})</span>`;
                    }
                    html += `</div>`;
                }
                html += '</div>';
            });

            html += '</div>';
            // Rapport de force (calcul sur base des scores compétitifs)
            html += `
                <div class="vs-stats">
                    <h3><span class="material-icons">bar_chart</span> Rapport de force entre équipes</h3>
            `;

            equipes.forEach((e1, i) => {
                equipes.forEach((e2, j) => {
                    if (i < j) {
                        // Utiliser les scores compétitifs
                        const ratio = (scores[i] / scores[j]).toFixed(2);
                        const part1 = (ratio * 100 / (1 + Number(ratio))).toFixed(1);
                        const part2 = (100 / (1 + Number(ratio))).toFixed(1);
                        html += `<div class="vs-row">Équipe ${i + 1} vs Équipe ${j + 1} : ${part1}% / ${part2}%</div>`;
                    }
                });
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        function changerEquipe(equipeIdx, joueurIdx) {
            const nouvelleEquipe = prompt('Numéro de la nouvelle équipe pour ce joueur (commence à 1) :');
            const numEquipe = parseInt(nouvelleEquipe) - 1;
            if (numEquipe >= 0 && numEquipe < equipes.length && numEquipe !== equipeIdx) {
                const joueur = equipes[equipeIdx].joueurs.splice(joueurIdx, 1)[0];
                equipes[numEquipe].joueurs.push(joueur);

                // Recalculer les totaux
                equipes.forEach(e => {
                    e.niveauTotal = e.joueurs.reduce((acc, j) => acc + j.niveau, 0);
                });

                afficherEquipes();
                showToast('Joueur déplacé avec succès');
            }
        }

        // === IMPORT / EXPORT ===
        function exporterJoueurs() {
            if (joueurs.length === 0) {
                showToast("Aucun joueur à exporter", true);
                return;
            }

            const contenu = joueurs.map(j => `${j.nom},${j.niveau},${j.poste}`).join('\n');
            const blob = new Blob([contenu], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "joueurs_exportes.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast("Joueurs exportés avec succès");
        }

        async function importerJoueurs() {
            const fichier = document.getElementById('fichierJoueurs').files[0];
            if (!fichier) {
                showToast("Aucun fichier sélectionné", true);
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                let ajouts = 0;
                const lignes = event.target.result.replace(/\r/g, '').split('\n');
                
                for (const ligne of lignes) {
                    const cleanLine = ligne.replace(/^\uFEFF/, '').trim();
                    if (!cleanLine) continue;

                    const sep = cleanLine.includes(';') ? ';' : ',';
                    const [nom, niveauStr, posteStr] = cleanLine.split(sep).map(x => x.trim());

                    if (!nom) continue;
                    
                    // Vérifier si le joueur existe déjà
                    if (joueurs.find(j => j.nom.toLowerCase() === nom.toLowerCase())) {
                        console.log(`Joueur ${nom} existe déjà, ignoré`);
                        continue;
                    }
                    
                    const niveau = parseInt(niveauStr);
                    const poste = (posteStr || "").toLowerCase();
                    const posteValide = ["avant", "arriere"].includes(poste) ? poste : "indifferent";
                    const niveauValide = (niveau >= 1 && niveau <= 10) ? niveau : 5;

                    const nouveauJoueur = { nom, niveau: niveauValide, poste: posteValide, actif: true };

                    try {
                        if (isOnline) {
                            const { data, error } = await supabaseClient
                                .from('players')
                                .insert([nouveauJoueur])
                                .select();
                            
                            if (error) throw error;
                            nouveauJoueur.id = data[0].id;
                        } else {
                            nouveauJoueur.id = Date.now() + ajouts; // ID temporaire en mode hors ligne
                        }

                        joueurs.push(nouveauJoueur);
                        ajouts++;
                    } catch (error) {
                        console.error('Erreur import joueur:', nom, error);
                    }
                }
                
                afficherJoueurs();
                updateStatus(`🟢 Connecté (${joueurs.length} joueurs)`, 'connected');
                showToast(`${ajouts} joueur(s) importé(s) avec succès`);
            };
            reader.readAsText(fichier, 'utf-8');
        }

        // === FONCTIONS SUPABASE ===
        async function synchroniser() {
            try {
                updateStatus('🔄 Synchronisation...', 'connecting');
                
                if (!isOnline) {
                    await init();
                    return;
                }
                
                await chargerJoueurs();
                
                afficherJoueurs();
                updateStatus(`🟢 Synchronisé (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');
                showToast('Synchronisation réussie !');
                
            } catch (error) {
                console.error('Erreur sync:', error);
                showToast('Erreur synchronisation: ' + error.message, true);
                updateStatus('🔴 Erreur sync', 'offline');
            }
        }

        async function viderBase() {
            if (!confirm('Vider toute la base de données ?')) return;
            
            try {
                if (isOnline) {
                    const { error } = await supabaseClient
                        .from('players')
                        .delete()
                        .neq('id', 0); // Supprimer tous
                    
                    if (error) throw error;
                    showToast('Base de données vidée !');
                } else {
                    showToast('Base locale vidée (mode hors ligne)');
                }
                
                joueurs = [];
                equipes = [];
                afficherJoueurs();
                document.getElementById('equipesContainer').innerHTML = '';
                updateStatus('🟢 Base vidée (0 joueurs)', 'connected');
                
            } catch (error) {
                console.error('Erreur vidage:', error);
                showToast('Erreur: ' + error.message, true);
            }
        }

        // === EVENT LISTENERS ===
        window.onload = () => {
            console.log("Page chargée - Initialisation des event listeners");
            
            // Initialiser Supabase
            init();
            
            // Boutons principaux
            document.getElementById('ajouterBtn').addEventListener('click', ajouterJoueur);
            document.getElementById('exportBtn').addEventListener('click', exporterJoueurs);
            document.getElementById('creerBtn').addEventListener('click', creerEquipes);
            document.getElementById('syncBtn').addEventListener('click', synchroniser);
            document.getElementById('clubSelect').addEventListener('change', changerClub);

            // Auto-import quand un fichier est sélectionné
            document.getElementById('fichierJoueurs').addEventListener('change', importerJoueurs);

            // Recherche et tri
            document.getElementById('searchInput').addEventListener('input', rechercherJoueurs);
            document.getElementById('clearSearch').addEventListener('click', effacerRecherche);
            document.getElementById('sortToggle').addEventListener('click', toggleTriJoueurs);

            // Support des touches Enter et Escape
            document.getElementById('nom').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') ajouterJoueur();
            });

            document.getElementById('niveau').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') ajouterJoueur();
            });

            document.getElementById('nombreEquipes').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') creerEquipes();
            });

            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Escape') effacerRecherche();
            });

            console.log("Event listeners attachés avec succès");
        };
    </script>
</body>
</html>