<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire d'√âquipes - Hockey Subaquatique</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Styles CSS modulaires -->
<link rel="stylesheet" href="assets/css/main.css">
<link rel="stylesheet" href="assets/css/components.css">
<link rel="stylesheet" href="assets/css/responsive.css">
</head>
<body>
    <div id="status" class="status connecting">üîÑ Connexion...</div>
    
    <div class="container">
        <!-- Titre principal -->
        <div class="card">
            <h1 style="text-align: center; color: #0077be; margin: 0; font-size: 28px;">
                ü§ø Gestionnaire d'√âquipes - Hockey Subaquatique üèí
            </h1>
        </div>

        <!-- S√©lecteur de Club -->
        <div class="club-selector">
            <div class="club-title">
                üèä‚Äç‚ôÇÔ∏è Club actuel :
            </div>
            <select id="clubSelect">
                <option value="grenoble">üîµ‚ö™üî¥ Grenoble (France)</option>
                <option value="jeeves">üåä Jeeves (UK)</option>
            </select>
            <div class="club-info" id="clubInfo">
                Chargement...
            </div>
        </div>

        <!-- Saisie des joueurs -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">person_add</span>
                Saisie des Joueurs
            </h2>
            <div class="form-grid">
                <div class="input-group">
                    <input id="nom" type="text" class="input-field" placeholder=" " required>
                    <label class="input-label">Nom du joueur</label>
                </div>
                <div class="input-group">
                    <input id="niveau" type="number" class="input-field" placeholder=" " min="1" max="10" required>
                    <label class="input-label">Niveau (1-10)</label>
                </div>
                <div class="input-group">
                    <select id="poste" class="input-field">
                        <option value="arriere">Arri√®re</option>
                        <option value="pivot">Pivot</option>
                        <option value="centre">Centre</option>
                        <option value="ailier">Ailier</option>
                        <option value="indifferent">Indiff√©rent</option>
                    </select>
                </div>
                <div class="input-group">
                    <input id="groupe" type="number" class="input-field" placeholder=" " min="1">
                    <label class="input-label">Groupe (optionnel)</label>
                </div>
                <button id="ajouterBtn" class="btn btn-primary">
                    <span class="material-icons">add</span>
                    Ajouter Joueur
                </button>
            </div>
        </div>
        <!-- Import / Export et Actions -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">import_export</span>
                Import / Export et Actions
            </h2>
            <div class="actions-grid">
                <div class="file-input-wrapper">
                    <input accept=".txt,.csv" id="fichierJoueurs" type="file" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('fichierJoueurs').click();">
                        <span class="material-icons">upload_file</span>
                        Importer fichier
                    </button>
                </div>
                <button id="exportBtn" class="btn btn-secondary">
                    <span class="material-icons">download</span>
                    Exporter CSV
                </button>
                <button id="syncBtn" class="btn btn-warning">
                    <span class="material-icons">sync</span>
                    Synchroniser
                </button>
            </div>
        </div>

        <!-- Composition des √©quipes -->
        <div class="card">
            <h2 class="card-title">
                <span class="material-icons">groups</span>
                Composition des √âquipes
            </h2>
            <div class="form-grid">
                <div class="input-group">
                    <input id="nombreEquipes" type="number" class="input-field" placeholder=" " min="1" required>
                    <label class="input-label">Nombre d'√©quipes</label>
                </div>
                <button id="creerBtn" class="btn btn-primary">
                    <span class="material-icons">group_add</span>
                    Cr√©er √âquipes
                </button>
            </div>
        </div>

        <!-- Liste des joueurs avec recherche -->
        <div class="card" id="listeJoueursCard" style="display: none;">
            <h2 class="card-title">
                <span class="material-icons">list</span>
                Liste des Joueurs
            </h2>
            
            <!-- Contr√¥les de recherche et tri -->
            <div class="search-controls">
                <div class="input-group search-input">
                    <input id="searchInput" type="text" class="input-field" placeholder=" ">
                    <label class="input-label">Rechercher un joueur...</label>
                </div>
                <button id="clearSearch" class="clear-search">
                    <span class="material-icons">clear</span>
                    Effacer
                </button>
                <button id="sortToggle" class="btn sort-toggle">
                    <span class="material-icons">sort_by_alpha</span>
                    <span id="sortText">Alphab√©tique</span>
                </button>
                <div class="search-stats" id="searchStats"></div>
            </div>
            
            <div id="listeJoueurs" class="player-list"></div>
        </div>

        <!-- √âquipes -->
        <div id="equipesContainer"></div>
    </div>

    <script>
        // === CONFIGURATION SUPABASE ===
        const SUPABASE_URL = 'https://wwonmuezjfvtfjjnxczx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3b25tdWV6amZ2dGZqam54Y3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NDUxMTQsImV4cCI6MjA2NjUyMTExNH0.P4TY4lyr0aXavzz8tJlZJFb0v2sDFMZstIFH2vvipnw';
        
        // === VARIABLES GLOBALES ===
        let supabaseClient;
        let joueurs = [];
        let equipes = [];
        let clubs = [];
        let clubActuel = null;
        let isOnline = false;
        let afficherTotal = true;
        let triJoueurs = 'alpha'; // Par d√©faut alphab√©tique
        let triEquipes = 'alpha'; // Tri pour les √©quipes
        let searchTerm = '';

        // === GESTION DES CLUBS ===
        function getClubSauvegarde() {
            return localStorage.getItem('hockeySub_clubActuel') || 'grenoble';
        }

        function sauvegarderClub(clubId) {
            localStorage.setItem('hockeySub_clubActuel', clubId);
        }

        function getTableName() {
            if (!clubActuel) return 'players_grenoble'; // fallback
            return clubActuel.nom.toLowerCase() === 'grenoble' ? 'players_grenoble' : 'players_jeeves';
        }


        async function chargerClubs() {
            try {
                const { data, error } = await supabaseClient.from('clubs').select('*');
                if (error) throw error;
                clubs = data || [];
                
                // Initialiser le club actuel
                const clubSauvegarde = getClubSauvegarde();
                clubActuel = clubs.find(c => c.nom.toLowerCase() === clubSauvegarde) || clubs[0];
                
                // Mettre √† jour le s√©lecteur
                document.getElementById('clubSelect').value = clubActuel.nom.toLowerCase();
                
                return clubs;
            } catch (error) {
                console.error('Erreur chargement clubs:', error);
                // Mode fallback
                clubs = [
                    { id: 1, nom: 'Grenoble' },
                    { id: 2, nom: 'Jeeves' }
                ];
                clubActuel = clubs[0];
                return clubs;
            }
        }

        function changerClub() {
            const selectClub = document.getElementById('clubSelect');
            const nomClub = selectClub.value;
            clubActuel = clubs.find(c => c.nom.toLowerCase() === nomClub);
            
            sauvegarderClub(nomClub);
            
            // Recharger les joueurs pour le nouveau club
            chargerJoueurs();
            
            showToast(`Bascul√© vers le club ${clubActuel.nom}`);
        }

        async function chargerJoueurs() {
    try {
        if (!clubActuel) return;
        
        const tableName = getTableName();
        console.log(`Chargement depuis la table: ${tableName}`);
        
        const { data, error } = await supabaseClient
            .from(tableName)  // ‚Üê FIX: utilise la table sp√©cifique au club
            .select('*');      // ‚Üê FIX: plus de filtrage par club_id
        
        if (error) throw error;
        
        joueurs = (data || []).map(j => ({
            id: j.id,
            nom: j.nom,
            niveau: j.niveau,
            poste: j.poste,
            groupe: j.groupe,
            actif: j.actif !== false
        }));
        
        // Mettre √† jour l'info du club
        document.getElementById('clubInfo').textContent = `${joueurs.length} joueur(s)`;
        
        return joueurs;
    } catch (error) {
        console.error('Erreur chargement joueurs:', error);
        joueurs = [];
        return [];
    }
}
        // === FONCTIONS UTILITAIRES ===
        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + className;
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // === INITIALISATION ===
        async function init() {
            try {
                updateStatus('üîÑ Connexion...', 'connecting');
                console.log('Initialisation...');
                
                // Cr√©er client Supabase
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Client Supabase cr√©√©');
                
                // Charger les clubs en premier
                await chargerClubs();
                console.log('Clubs charg√©s:', clubs);
                
                // Charger les joueurs pour le club actuel
                await chargerJoueurs();
                
                isOnline = true;
                updateStatus(`üü¢ Connect√© (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');
                console.log('Connexion OK, joueurs charg√©s:', joueurs.length);
                afficherJoueurs();
                showToast(`Connexion r√©ussie ! Club: ${clubActuel.nom}`);
                
            } catch (error) {
                console.error('Erreur connexion:', error);
                isOnline = false;
                updateStatus('üî¥ Hors ligne', 'offline');
                showToast('Mode hors ligne - ' + (error.message || 'Connexion impossible'), true);
            }
        }

        // === GESTION DES JOUEURS ===
        async function ajouterJoueur() {
    const nom = document.getElementById('nom').value.trim();
    const niveau = parseInt(document.getElementById('niveau').value);
    const poste = document.getElementById('poste').value;
    const groupe = parseInt(document.getElementById('groupe').value) || null;

    if (!nom) {
        showToast('Veuillez saisir un nom de joueur', true);
        return;
    }

    if (!niveau || niveau < 1 || niveau > 10) {
        showToast('Le niveau doit √™tre entre 1 et 10', true);
        return;
    }

    // V√©rifier si le joueur existe d√©j√†
    if (joueurs.find(j => j.nom.toLowerCase() === nom.toLowerCase())) {
        showToast('Ce joueur existe d√©j√†', true);
        return;
    }

    const nouveauJoueur = { nom, niveau, poste, groupe, actif: true };
    // ‚Üê FIX: Plus de club_id dans l'objet

    try {
        if (isOnline) {
            const tableName = getTableName();
            console.log(`Ajout dans la table: ${tableName}`);
            
            const { data, error } = await supabaseClient
                .from(tableName)  // ‚Üê FIX: utilise la table sp√©cifique au club
                .insert([nouveauJoueur])
                .select();
            
            if (error) throw error;
            
            nouveauJoueur.id = data[0].id;
            showToast(`Joueur ${nom} ajout√© et synchronis√© !`);
        } else {
            nouveauJoueur.id = Date.now(); // ID temporaire en mode hors ligne
            showToast(`Joueur ${nom} ajout√© (mode hors ligne)`);
        }

        joueurs.push(nouveauJoueur);
        afficherJoueurs();
        updateStatus(`üü¢ Connect√© (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');

        // Reset form
        document.getElementById('nom').value = '';
        document.getElementById('niveau').value = '';
        document.getElementById('groupe').value = '';
        document.getElementById('nom').focus();

    } catch (error) {
        console.error('Erreur ajout joueur:', error);
        showToast('Erreur: ' + error.message, true);
    }
}

       async function supprimerJoueur(index) {
    if (!confirm("Supprimer ce joueur ?")) return;
    
    const joueur = joueurs[index];
    const nom = joueur.nom;

    try {
        if (isOnline && joueur.id) {
            const tableName = getTableName();
            console.log(`Suppression de la table: ${tableName}`);
            
            const { error } = await supabaseClient
                .from(tableName)  // ‚Üê FIX: utilise la table sp√©cifique au club
                .delete()
                .eq('id', joueur.id);
            
            if (error) throw error;
            showToast(`Joueur ${nom} supprim√© de la base !`);
        } else {
            showToast(`Joueur ${nom} supprim√© (mode hors ligne)`);
        }
        
        joueurs.splice(index, 1);
        afficherJoueurs();
        updateStatus(`üü¢ Connect√© (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');
        
    } catch (error) {
        console.error('Erreur suppression:', error);
        showToast('Erreur: ' + error.message, true);
    }
}
        async function modifierJoueur(index, champ, valeur) {
            const joueur = joueurs[index];
            const ancienneValeur = joueur[champ];

            if (champ === 'nom') {
                const nouveauNom = valeur.trim();
                if (!nouveauNom) {
                    showToast('Le nom ne peut pas √™tre vide', true);
                    afficherJoueurs(); // Restaurer l'ancien nom
                    return;
                }
                // V√©rifier si le nom existe d√©j√†
                const nomExiste = joueurs.some((j, i) => i !== index && j.nom.toLowerCase() === nouveauNom.toLowerCase());
                if (nomExiste) {
                    showToast('Ce nom existe d√©j√†', true);
                    afficherJoueurs(); // Restaurer l'ancien nom
                    return;
                }
                joueur[champ] = nouveauNom;
                showToast(`Nom modifi√© : ${ancienneValeur} ‚Üí ${nouveauNom}`);
            } else if (champ === 'niveau') {
                const niveau = parseInt(valeur);
                if (niveau < 1 || niveau > 10) {
                    showToast('Le niveau doit √™tre entre 1 et 10', true);
                    afficherJoueurs();
                    return;
                }
                joueur[champ] = niveau;
            } else if (champ === 'actif') {
                joueur[champ] = valeur;
            } else if (champ === 'groupe') {
                joueur[champ] = valeur ? parseInt(valeur) : null;
            } else {
                joueur[champ] = valeur;
            }

            // Synchroniser avec Supabase si en ligne
try {
    if (isOnline && joueur.id) {
        const tableName = getTableName();
        console.log(`Modification dans la table: ${tableName}`);
        
        const updateData = {
            nom: joueur.nom,
            niveau: joueur.niveau,
            poste: joueur.poste,
            groupe: joueur.groupe,
            actif: joueur.actif
        };

        const { error } = await supabaseClient
            .from(tableName)  // ‚Üê FIX: utilise la table sp√©cifique au club
            .update(updateData)
            .eq('id', joueur.id);
        
        if (error) throw error;
    }
} catch (error) {
    console.error('Erreur synchronisation modification:', error);
    showToast('Modification locale OK, sync √©chou√©e', true);
}

            afficherJoueurs();
            
            // Si des √©quipes existent, les mettre √† jour aussi
            if (equipes.length > 0) {
                equipes.forEach(equipe => {
                    const joueurDansEquipe = equipe.joueurs.find(j => j.id === joueur.id || j.nom === ancienneValeur);
                    if (joueurDansEquipe && champ === 'nom') {
                        joueurDansEquipe.nom = valeur.trim();
                    }
                });
                afficherEquipes();
            }
        }

        // === FONCTIONS DE RECHERCHE ET TRI ===
        function rechercherJoueurs() {
            searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            afficherJoueurs();
        }

        function effacerRecherche() {
            document.getElementById('searchInput').value = '';
            searchTerm = '';
            afficherJoueurs();
        }

        function filtrerJoueurs(joueursListe) {
            if (!searchTerm) return joueursListe;
            return joueursListe.filter(joueur => 
                joueur.nom.toLowerCase().includes(searchTerm) ||
                joueur.poste.toLowerCase().includes(searchTerm) ||
                joueur.niveau.toString().includes(searchTerm)
            );
        }

        function trierJoueurs(joueursListe) {
            const joueursCopie = [...joueursListe];
            if (triJoueurs === 'alpha') {
                return joueursCopie.sort((a, b) => a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
            } else {
                return joueursCopie.sort((a, b) => b.niveau - a.niveau || a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
            }
        }

        function toggleTriJoueurs() {
            triJoueurs = triJoueurs === 'niveau' ? 'alpha' : 'niveau';
            document.getElementById('sortText').textContent = triJoueurs === 'alpha' ? 'Alphab√©tique' : 'Par niveau';
            afficherJoueurs();
        }

        function toggleTriEquipes() {
            triEquipes = triEquipes === 'niveau' ? 'alpha' : 'niveau';
            afficherEquipes();
        }

        function toggleTotalNiveaux() {
            afficherTotal = !afficherTotal;
            afficherEquipes();
        }

        // === AFFICHAGE DES JOUEURS ===
        function afficherJoueurs() {
            const carte = document.getElementById('listeJoueursCard');
            const liste = document.getElementById('listeJoueurs');
            const statsElement = document.getElementById('searchStats');

            if (joueurs.length === 0) {
                carte.style.display = 'none';
                return;
            }

            carte.style.display = 'block';
            liste.innerHTML = '';

            // Trier puis filtrer les joueurs
            const joueursTries = trierJoueurs(joueurs);
            const joueursFiltres = filtrerJoueurs(joueursTries);

            // Mettre √† jour les statistiques
            const totalJoueurs = joueurs.length;
            const joueursActifs = joueurs.filter(j => j.actif).length;
            const joueursAffiches = joueursFiltres.length;
            
            let statsText = `${totalJoueurs} joueur(s) total`;
            if (joueursActifs !== totalJoueurs) {
                statsText += ` (${joueursActifs} actifs)`;
            }
            if (searchTerm) {
                statsText += ` - ${joueursAffiches} trouv√©(s)`;
            }
            statsElement.textContent = statsText;

            joueursFiltres.forEach((j, index) => {
                const originalIndex = joueurs.indexOf(j);
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${!j.actif ? 'inactive' : ''}`;

                playerCard.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" ${j.actif ? 'checked' : ''} onchange="modifierJoueur(${originalIndex}, 'actif', this.checked)">
                    </div>
                    <div class="player-info">
                        <div class="player-field">
                            <input type="text" value="${j.nom}" class="player-name-input" 
                                   onchange="modifierJoueur(${originalIndex}, 'nom', this.value)"
                                   onblur="modifierJoueur(${originalIndex}, 'nom', this.value)"
                                   placeholder="Nom du joueur">
                        </div>
                        <div class="player-field">
                            <div class="niveau-wrapper">
                                <span class="niveau-label">Niv.</span>
                                <input type="number" value="${j.niveau}" min="1" max="10" 
                                       onchange="modifierJoueur(${originalIndex}, 'niveau', this.value)"
                                       placeholder="1-10" title="Niveau de 1 √† 10">
                            </div>
                        </div>
                        <div class="player-field">
                            <select onchange="modifierJoueur(${originalIndex}, 'poste', this.value)" title="Position du joueur">
                                <option value="arriere" ${j.poste==='arriere'?'selected':''}>Arri√®re</option>
                                <option value="pivot" ${j.poste==='pivot'?'selected':''}>Pivot</option>
                                <option value="centre" ${j.poste==='centre'?'selected':''}>Centre</option>
                                <option value="ailier" ${j.poste==='ailier'?'selected':''}>Ailier</option>
                                <option value="indifferent" ${j.poste==='indifferent'?'selected':''}>Indiff√©rent</option>
                            </select>
                        </div>
                        <div class="player-field">
                            <input type="number" value="${j.groupe || ''}" min="1" 
                                   onchange="modifierJoueur(${originalIndex}, 'groupe', this.value)"
                                   placeholder="Groupe" title="Num√©ro de groupe (optionnel)">
                        </div>
                    </div>
                    <button onclick="supprimerJoueur(${originalIndex})" class="btn btn-danger">
                        <span class="material-icons">delete</span>
                    </button>
                `;

                liste.appendChild(playerCard);
            });
        }

        // === CR√âATION ET AFFICHAGE DES √âQUIPES ===
        function creerEquipes() {
            const nbEquipes = parseInt(document.getElementById('nombreEquipes').value);
            if (isNaN(nbEquipes) || nbEquipes <= 0) {
                showToast('Nombre d\'√©quipes invalide', true);
                return;
            }

            const joueursActifs = joueurs.filter(j => j.actif);
            if (joueursActifs.length === 0) {
                showToast('Aucun joueur actif disponible', true);
                return;
            }

            equipes = Array.from({length: nbEquipes}, () => ({
                joueurs: [],
                niveauTotal: 0,
                meilleurNiveau: 0,
                avant: 0,
                arriere: 0
            }));

            const groupes = {};
            const sansGroupe = [];

            joueursActifs.forEach(j => {
                if (j.groupe) {
                    if (!groupes[j.groupe]) groupes[j.groupe] = [];
                    groupes[j.groupe].push(j);
                } else {
                    sansGroupe.push(j);
                }
            });

            // Assigner les groupes ensemble
            Object.values(groupes).forEach(groupe => {
                groupe.sort((a,b) => b.niveau - a.niveau);
                equipes.sort((a,b) => a.niveauTotal - b.niveauTotal);
                groupe.forEach(j => {
                    let poste = j.poste;
                    if (poste === 'indifferent') poste = equipes[0].avant <= equipes[0].arriere ? 'avant' : 'arriere';
                    equipes[0].joueurs.push({...j, poste});
                    equipes[0].niveauTotal += j.niveau;
                    equipes[0].meilleurNiveau = Math.max(equipes[0].meilleurNiveau, j.niveau);
                    equipes[0][poste]++;
                });
            });

            // Ajouter les joueurs seuls
            sansGroupe.sort((a,b) => b.niveau - a.niveau);
            sansGroupe.forEach(joueur => {
                equipes.sort((a,b) => a.niveauTotal - b.niveauTotal);
                let poste = joueur.poste;
                if (poste === 'indifferent') poste = equipes[0].avant <= equipes[0].arriere ? 'avant' : 'arriere';
                equipes[0].joueurs.push({...joueur, poste});
                equipes[0].niveauTotal += joueur.niveau;
                equipes[0].meilleurNiveau = Math.max(equipes[0].meilleurNiveau, joueur.niveau);
                equipes[0][poste]++;
            });

            afficherEquipes();
            showToast('√âquipes cr√©√©es avec succ√®s');
        }

        function afficherEquipes() {
            const container = document.getElementById('equipesContainer');
            if (equipes.length === 0) {
                container.innerHTML = '';
                return;
            }

            // Calcul des scores "comp√©titifs" (6 meilleurs joueurs max) + 2√®me meilleur joueur
            function scoreEquipe(equipe) {
                let joueursOrdonnes = [...equipe.joueurs].sort((a, b) => b.niveau - a.niveau);
                if (joueursOrdonnes.length > 6) {
                    const joueursPrisEnCompte = joueursOrdonnes.slice(0, 6);
                    const joueursIgnor√©s = joueursOrdonnes.slice(6);
                    const meilleur = joueursPrisEnCompte[0]?.niveau || 0;
                    const second = joueursPrisEnCompte[1]?.niveau || 0;
                    const total = joueursPrisEnCompte.reduce((acc, j) => acc + j.niveau, 0);
                    return {
                        score: total * 0.6 + meilleur * 0.25 + second * 0.15,
                        meilleur,
                        second,
                        joueursIgnor√©s
                    };
                } else {
                    const meilleur = joueursOrdonnes[0]?.niveau || 0;
                    const second = joueursOrdonnes[1]?.niveau || 0;
                    const total = equipe.niveauTotal;
                    return {
                        score: total * 0.6 + meilleur * 0.25 + second * 0.15,
                        meilleur,
                        second,
                        joueursIgnor√©s: []
                    };
                }
            }
            
            // Calcul des scores comp√©titifs pour chaque √©quipe
            const scoresObj = equipes.map(e => scoreEquipe(e));
            const scores = scoresObj.map(e => e.score);

            let html = `
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-icons">groups</span>
                        √âquipes Constitu√©es
                        <button onclick="toggleTotalNiveaux()" class="btn btn-secondary" style="margin-left: auto;">
                            ${afficherTotal ? 'Cacher' : 'Afficher'} totaux
                        </button>
                        <button onclick="toggleTriEquipes()" class="btn btn-secondary" style="margin-left: 8px;">
                            Trier : ${triEquipes === 'niveau' ? 'par niveau' : 'alphab√©tique'}
                        </button>
                    </h2>
                    <div class="teams-grid">
            `;

            equipes.forEach((e, idx) => {
                const teamColors = ['#1976d2', '#388e3c', '#f57c00', '#d32f2f'];
                const color = teamColors[idx % teamColors.length];

                html += `
                    <div class="team-card">
                        <div class="team-title" style="color: ${color}">
                            <span class="material-icons">group</span>
                            √âquipe ${idx + 1}
                        </div>
                        <ul class="team-players">
                `;

                // Tri dynamique des joueurs dans les √©quipes
                let joueursAffiches = [...e.joueurs];
                if (triEquipes === 'niveau') {
                    joueursAffiches.sort((a, b) => b.niveau - a.niveau);
                } else if (triEquipes === 'alpha') {
                    joueursAffiches.sort((a, b) => a.nom.localeCompare(b.nom, 'fr', { sensitivity: 'base' }));
                }

                joueursAffiches.forEach((j, joueurIdx) => {
                    html += `
                        <li class="team-player" onclick="changerEquipe(${idx}, ${e.joueurs.indexOf(j)})">
                            <span class="material-icons">person</span>
                            ${j.nom} - ${j.poste}${afficherTotal ? ' (' + j.niveau + ')' : ''}
                        </li>
                    `;
                });

                html += '</ul>';
                if (afficherTotal) {
                    html += `<div class="team-total">Score comp√©titif : ${scoresObj[idx].score.toFixed(2)}<br>
                        <span style="font-size:12px;">
                        (Somme √ó 0.6 : ${(e.joueurs.length > 6 
                            ? [...e.joueurs].sort((a,b) => b.niveau-a.niveau).slice(0,6).reduce((acc, j) => acc+j.niveau,0)
                            : e.niveauTotal
                        ).toFixed(2)}
                        , meilleur √ó 0.25 : ${(scoresObj[idx].meilleur*0.25).toFixed(2)}
                        , 2e meilleur √ó 0.15 : ${(scoresObj[idx].second*0.15).toFixed(2)})
                        </span>`;
                    if (scoresObj[idx].joueursIgnor√©s.length > 0) {
                        html += `<br><span style="color:#d32f2f; font-size:12px;">(Le(s) joueur(s) non pris en compte : ${scoresObj[idx].joueursIgnor√©s.map(j => j.nom).join(', ')})</span>`;
                    }
                    html += `</div>`;
                }
                html += '</div>';
            });

            html += '</div>';
            // Rapport de force (calcul sur base des scores comp√©titifs)
            html += `
                <div class="vs-stats">
                    <h3><span class="material-icons">bar_chart</span> Rapport de force entre √©quipes</h3>
            `;

            equipes.forEach((e1, i) => {
                equipes.forEach((e2, j) => {
                    if (i < j) {
                        // Utiliser les scores comp√©titifs
                        const ratio = (scores[i] / scores[j]).toFixed(2);
                        const part1 = (ratio * 100 / (1 + Number(ratio))).toFixed(1);
                        const part2 = (100 / (1 + Number(ratio))).toFixed(1);
                        html += `<div class="vs-row">√âquipe ${i + 1} vs √âquipe ${j + 1} : ${part1}% / ${part2}%</div>`;
                    }
                });
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        function changerEquipe(equipeIdx, joueurIdx) {
            const nouvelleEquipe = prompt('Num√©ro de la nouvelle √©quipe pour ce joueur (commence √† 1) :');
            const numEquipe = parseInt(nouvelleEquipe) - 1;
            if (numEquipe >= 0 && numEquipe < equipes.length && numEquipe !== equipeIdx) {
                const joueur = equipes[equipeIdx].joueurs.splice(joueurIdx, 1)[0];
                equipes[numEquipe].joueurs.push(joueur);

                // Recalculer les totaux
                equipes.forEach(e => {
                    e.niveauTotal = e.joueurs.reduce((acc, j) => acc + j.niveau, 0);
                });

                afficherEquipes();
                showToast('Joueur d√©plac√© avec succ√®s');
            }
        }

        // === IMPORT / EXPORT ===
        function exporterJoueurs() {
            if (joueurs.length === 0) {
                showToast("Aucun joueur √† exporter", true);
                return;
            }

            const contenu = joueurs.map(j => `${j.nom},${j.niveau},${j.poste}`).join('\n');
            const blob = new Blob([contenu], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = "joueurs_exportes.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast("Joueurs export√©s avec succ√®s");
        }

        async function importerJoueurs() {
            const fichier = document.getElementById('fichierJoueurs').files[0];
            if (!fichier) {
                showToast("Aucun fichier s√©lectionn√©", true);
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                let ajouts = 0;
                const lignes = event.target.result.replace(/\r/g, '').split('\n');
                
                for (const ligne of lignes) {
                    const cleanLine = ligne.replace(/^\uFEFF/, '').trim();
                    if (!cleanLine) continue;

                    const sep = cleanLine.includes(';') ? ';' : ',';
                    const [nom, niveauStr, posteStr] = cleanLine.split(sep).map(x => x.trim());

                    if (!nom) continue;
                    
                    // V√©rifier si le joueur existe d√©j√†
                    if (joueurs.find(j => j.nom.toLowerCase() === nom.toLowerCase())) {
                        console.log(`Joueur ${nom} existe d√©j√†, ignor√©`);
                        continue;
                    }
                    
                    const niveau = parseInt(niveauStr);
                    const poste = (posteStr || "").toLowerCase();
                    const posteValide = ["avant", "arriere"].includes(poste) ? poste : "indifferent";
                    const niveauValide = (niveau >= 1 && niveau <= 10) ? niveau : 5;

                    const nouveauJoueur = { nom, niveau: niveauValide, poste: posteValide, actif: true };

                    try {
                        if (isOnline) {
                            const { data, error } = await supabaseClient
                                .from('players')
                                .insert([nouveauJoueur])
                                .select();
                            
                            if (error) throw error;
                            nouveauJoueur.id = data[0].id;
                        } else {
                            nouveauJoueur.id = Date.now() + ajouts; // ID temporaire en mode hors ligne
                        }

                        joueurs.push(nouveauJoueur);
                        ajouts++;
                    } catch (error) {
                        console.error('Erreur import joueur:', nom, error);
                    }
                }
                
                afficherJoueurs();
                updateStatus(`üü¢ Connect√© (${joueurs.length} joueurs)`, 'connected');
                showToast(`${ajouts} joueur(s) import√©(s) avec succ√®s`);
            };
            reader.readAsText(fichier, 'utf-8');
        }

        // === FONCTIONS SUPABASE ===
        async function synchroniser() {
            try {
                updateStatus('üîÑ Synchronisation...', 'connecting');
                
                if (!isOnline) {
                    await init();
                    return;
                }
                
                await chargerJoueurs();
                
                afficherJoueurs();
                updateStatus(`üü¢ Synchronis√© (${joueurs.length} joueurs - ${clubActuel.nom})`, 'connected');
                showToast('Synchronisation r√©ussie !');
                
            } catch (error) {
                console.error('Erreur sync:', error);
                showToast('Erreur synchronisation: ' + error.message, true);
                updateStatus('üî¥ Erreur sync', 'offline');
            }
        }

        async function viderBase() {
            if (!confirm('Vider toute la base de donn√©es ?')) return;
            
            try {
                if (isOnline) {
                    const { error } = await supabaseClient
                        .from('players')
                        .delete()
                        .neq('id', 0); // Supprimer tous
                    
                    if (error) throw error;
                    showToast('Base de donn√©es vid√©e !');
                } else {
                    showToast('Base locale vid√©e (mode hors ligne)');
                }
                
                joueurs = [];
                equipes = [];
                afficherJoueurs();
                document.getElementById('equipesContainer').innerHTML = '';
                updateStatus('üü¢ Base vid√©e (0 joueurs)', 'connected');
                
            } catch (error) {
                console.error('Erreur vidage:', error);
                showToast('Erreur: ' + error.message, true);
            }
        }

        // === EVENT LISTENERS ===
        window.onload = () => {
            console.log("Page charg√©e - Initialisation des event listeners");
            
            // Initialiser Supabase
            init();
            
            // Boutons principaux
            document.getElementById('ajouterBtn').addEventListener('click', ajouterJoueur);
            document.getElementById('exportBtn').addEventListener('click', exporterJoueurs);
            document.getElementById('creerBtn').addEventListener('click', creerEquipes);
            document.getElementById('syncBtn').addEventListener('click', synchroniser);
            document.getElementById('clubSelect').addEventListener('change', changerClub);

            // Auto-import quand un fichier est s√©lectionn√©
            document.getElementById('fichierJoueurs').addEventListener('change', importerJoueurs);

            // Recherche et tri
            document.getElementById('searchInput').addEventListener('input', rechercherJoueurs);
            document.getElementById('clearSearch').addEventListener('click', effacerRecherche);
            document.getElementById('sortToggle').addEventListener('click', toggleTriJoueurs);

            // Support des touches Enter et Escape
            document.getElementById('nom').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') ajouterJoueur();
            });

            document.getElementById('niveau').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') ajouterJoueur();
            });

            document.getElementById('nombreEquipes').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') creerEquipes();
            });

            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Escape') effacerRecherche();
            });

            console.log("Event listeners attach√©s avec succ√®s");
        };
    </script>
</body>
</html>
